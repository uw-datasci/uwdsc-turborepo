name: Vercel CI/CD

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 22
  PNPM_VERSION: 10.26.0

jobs:
  setup:
    name: Setup & Install Dependencies
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ env.NODE_VERSION }}
      pnpm-version: ${{ env.PNPM_VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

  quality-web:
    name: Quality Gate - Web
    needs: setup
    uses: uw-datasci/nexus-workflows/.github/workflows/quality-gate.yml@v3
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      lint-command: pnpm --filter=web... lint
      typecheck-command: pnpm --filter=web... check-types

  quality-cxc:
    name: Quality Gate - CxC
    needs: setup
    uses: uw-datasci/nexus-workflows/.github/workflows/quality-gate.yml@v3
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      lint-command: pnpm --filter=cxc... lint
      typecheck-command: pnpm --filter=cxc... check-types

  deploy-web:
    name: Build & Deploy - Web
    needs: [setup, quality-web]
    uses: uw-datasci/nexus-workflows/.github/workflows/deploy-vercel.yml@v3
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      infisical-project-slug: uwdsc-54e-y
      infisical-secret-path: /web
      is-prod: ${{ github.event_name == 'push' }}
    secrets:
      INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
      INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

  deploy-cxc:
    name: Build & Deploy - CxC
    needs: [setup, quality-cxc]
    uses: uw-datasci/nexus-workflows/.github/workflows/deploy-vercel.yml@v3
    with:
      node-version: ${{ needs.setup.outputs.node-version }}
      pnpm-version: ${{ needs.setup.outputs.pnpm-version }}
      infisical-project-slug: uwdsc-54e-y
      infisical-secret-path: /cxc
      is-prod: ${{ github.event_name == 'push' }}
    secrets:
      INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
      INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_CXC }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

  deployment-summary:
    name: Deployment Summary
    needs: [deploy-web, deploy-cxc]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: uw-datasci/nexus-vercel-summary@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployments: |
            [
              {
                "name": "Web",
                "status": "${{ needs.deploy-web.result == 'success' && 'successful' || 'failed' }}",
                "url": "${{ needs.deploy-web.outputs.deployment-url }}"
              },
              {
                "name": "CxC",
                "status": "${{ needs.deploy-cxc.result == 'success' && 'successful' || 'failed' }}",
                "url": "${{ needs.deploy-cxc.outputs.deployment-url }}"
              }
            ]
