name: Fetch Secrets Proxy

on:
  workflow_dispatch:
    inputs:
      encryption_passphrase:
        description: "One-time passphrase"
        required: true

jobs:
  fetch-and-encrypt:
    runs-on: ubuntu-latest
    steps:
      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y infisical

      - name: Authenticate & Export
        run: |
          # 1. Login
          export INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id=${{ secrets.INFISICAL_CLIENT_ID }} --client-secret=${{ secrets.INFISICAL_CLIENT_SECRET }} --silent --plain)

          # 2. Export web secrets
          echo "Fetching /web..."
          infisical export --path=/web --env=dev --format=dotenv > web.env

          # 3. Export cxc secrets
          echo "Fetching /cxc..."
          infisical export --path=/cxc --env=dev --format=dotenv > cxc.env

      - name: Bundle and Encrypt
        run: |
          # 1. Combine into JSON using jq (safely handles newlines/escaping)
          # We create a JSON object: { "web": "...", "cxc": "..." }
          jq -n --rawfile web web.env --rawfile cxc cxc.env '{web: $web, cxc: $cxc}' > secrets.json

          # 2. Encrypt the JSON file
          openssl enc -aes-256-cbc -salt -pbkdf2 -iter 10000 -in secrets.json -out secrets.enc -pass pass:${{ inputs.encryption_passphrase }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: encrypted-secrets-${{ github.run_id }}
          path: secrets.enc
          retention-days: 1
